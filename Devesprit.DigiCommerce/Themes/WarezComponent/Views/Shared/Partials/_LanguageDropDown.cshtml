
@using Devesprit.Core
@using Devesprit.Utilities
@using Devesprit.Services.Languages
@using Devesprit.Core.Settings
@using Devesprit.Services

@{
    Layout = null;
    var languageService = DependencyResolver.Current.GetService<ILanguagesService>();
    var settings = DependencyResolver.Current.GetService<ISettingService>().LoadSetting<SiteSettings>();
    var workContext = DependencyResolver.Current.GetService<IWorkContext>();
    var allLanguages = languageService.GetAsEnumerable().ToList();
    var targetPath = Request.Url.PathAndQuery.TrimStart('/');

    foreach (var language in allLanguages)
    {
        if (targetPath.StartsWith(language.IsoCode, StringComparison.OrdinalIgnoreCase))
        {
            targetPath = targetPath.Remove(0, language.IsoCode.Length).TrimStart('/');
            break;
        }
    }

    var hostRoot = $"{Request.Url.Scheme}://{Request.Url.Authority}";
    var targetUrlMask = settings.AppendLanguageCodeToUrl ? $"{hostRoot}/{{0}}/{targetPath.TrimStart('/')}" : $"{hostRoot}/{targetPath.TrimStart('/')}";

    var curLang = workContext.CurrentLanguage;

    var jsLanguageArray = "'" + string.Join("','", allLanguages.Select(p => p.IsoCode)) + "'";
}

@if (allLanguages.Count > 1)
{
    <div class="select_mate select-lang" data-mate-select="active">
        <select name="" onclick="return false;" id="">
            @foreach (var item in allLanguages)
            {
                <option value="@item.IsoCode" @Html.Raw(curLang.IsoCode == item.IsoCode ? "selected" : "")>@item.LanguageName</option>
            }
        </select>
        <p class="selecionado_opcion" onclick="open_select(this)"></p>
        <span onclick="open_select(this)" class="icon_select_mate">
            <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z" />
                <path d="M0-.75h24v24H0z" fill="none" />
            </svg>
        </span>
        <div class="cont_list_select_mate">
            <ul class="cont_select_int" onclick="ChangeLanguage($(this).children('li.active').attr('data-index'));"> </ul>
        </div>
    </div>

    Html.AddInlineScript(ResourceLocation.Footer,
        @<script>
             function ChangeLanguage(idx) {
                 var langList = [@Html.Raw(jsLanguageArray)];
                 var selectedLang = langList[idx];
                 var targetUrl = "@targetUrlMask".format(selectedLang);

                 $.ajax({
                     type: "POST",
                     url: targetUrl,
                     data: { usl: selectedLang },
                     success: function() {
                         location.href = targetUrl;
                     }
                 });
             }
         </script>, true);
}
